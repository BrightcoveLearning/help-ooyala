<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en-us" lang="en-us">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2005"/>
<meta name="DC.rights.owner" content="(C) Copyright 2005"/>
<meta name="DC.Type" content="concept"/>
<meta name="DC.Title" content="Offline Playback: Download to Own (DTO) and Rentals (DTR) for Android"/>
<meta name="abstract" content=""/>
<meta name="description" content=""/>
<meta name="DC.Relation" scheme="URI" content="../concepts/mobile_sdk_android_about.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="offline_playback_download_to_own_dto_for_android"/>
<link rel="stylesheet" type="text/css" href="../css/commonltr.css"/>
<link rel="stylesheet" type="text/css" href="../css/ooyala.css"/>
<title>Offline Playback: Download to Own (DTO) and Rentals (DTR) for Android</title>
</head>
<body id="offline_playback_download_to_own_dto_for_android">


 <h1 class="title topictitle1">Offline Playback: Download to Own (DTO) and Rentals (DTR) for Android</h1>

 
 <div class="body conbody"><p class="shortdesc"/>

  <div class="section">The Ooyala SDK for Android utilizes the capabilities provided by Google's ExoPlayer to support
   offline playback. ExoPlayer allows parsing of DASH streams. The Ooyala SDK for Android
   utilizes Widevine as the DRM server to store a DRM license from a Widevine Server.
   Developers can utilize the Ooyala SDK for Androidin their apps to download DASH assets
   stored in our CMSs (e.g. Backlot) for offline playback.</div>

  <div class="section"><h2 class="title sectiontitle">Capabilities</h2>
  <p class="p">With the Ooyala SDK, you will be able to:</p>

  <ul class="ul">
   <li class="li">Download an asset.</li>

   <li class="li">Cancel a download in progress.</li>

   <li class="li">Resume a download of an asset. This one applies when cancelling a download, if you try to download it again it will use the segments already downloaded previously so you will be saving time.</li>

   <li class="li">Listen to updates on the download process.</li>

   <li class="li">Delete a downloaded asset.</li>

   <li class="li">Play a downloaded asset.</li>

   <li class="li">Check license expiration date.</li>

   <li class="li">Prevent a downloaded asset from being played after a specific date.</li>

  </ul>

  <p class="p">We currently do not support:</p>

  <ul class="ul">
   <li class="li">Closed captions for the downloaded asset.</li>

   <li class="li">A promo or static image representing the downloaded asset.</li>

   <li class="li">Multi-audio (e.g. Spanish, English, etc). The SDK will download the default language for the asset.</li>

   <li class="li">Pausing a download in progress.</li>

   <li class="li">Estimating the size of the video to download.</li>

   <li class="li">Auto delete assets that have an expired license.</li>

  </ul>

  <div class="note note"><span class="notetitle">Note:</span> When uninstalling the app used to download assets, the contents of the downloaded assets
        will remain on the device. This is expected behavior. You have two options to remove
        downloaded assets: <ol class="ol" id="offline_playback_download_to_own_dto_for_android__ol_rrl_gyr_3y">
          <li class="li">Using the DTO APIs, delete the assets before uninstalling the app
            (<em class="ph i">recommended</em>), or</li>

          <li class="li">Maually searching for the file and remove it (<em class="ph i">not supported</em>)</li>

        </ol>
</div>

  </div>

  <div class="section"><h2 class="title sectiontitle">Requirements</h2>
  <p class="p">DTO and DTR using the Ooyala Android SDK requires:</p>

  <ul class="ul">
   <li class="li">Android 4.1 (API 16) for non-protected, clear DASH assets.</li>

   <li class="li">Android 4.3 (API 18) for Widevine DASH assets.</li>

   <li class="li">Google ExoPlayer.</li>

   <li class="li">Android Ooyala SDK v4.21.0 and above.</li>

   <li class="li">Widevine DASH assets for defining rentals entitlements (DTR).</li>

   <li class="li">Android 5+ only for DTR.</li>

  </ul>

  <p class="p">Android supports downloading the following video formats:</p>

  <ul class="ul">
   <li class="li">Non protected clear DASH assets.</li>

   <li class="li">Widevine DASH assets.</li>

  </ul>

    <div class="note note"><span class="notetitle">Note:</span> We encountered problems with Widevine license expiration in Android 4.x devices, where
        offline playback was still allowed after the expiration. Because the license has an
        expiration date that it is not being enforced by the system (Android and Widevine), we are
        not able to support DTR functionality below Android 5. We recommend not deploying DTR to
        Android v4.x devices until a fix is found. For Android 5 and above, whenever the Widevine
        license expires, as expected, users will not be able to play the particular video linked to
        that license.</div>

  </div>

  <div class="section"><h2 class="title sectiontitle">Offline Playback Use-Cases: Buy and Rent</h2>
  <p class="p">There are several use cases for offline videos. We expose the same client APIs for Download to
      Own (DTO) and Download to Rent (DTR), but the difference is that we consider assets to be DTO
      if they are clear DASH or Widevine DASH with an infinite license, meaning the license will
      never expire, and if you download an asset with these characteristics you will be able to play
      as long as it remains on your device. On the other hand, Rentals (DTR) requires Widevine DASH
      assets with a finite license. The access windows are defined by the entitlement settings,
      setting the expiration date for when a downloaded asset will no longer be playable by the
      user.</p>

   <p class="p">To add rental access period rules for your assets, you must set entitlements for them. For
      more information, see <a class="xref" href="../api/rightslocker.html#reference_rj1_dzd_v3">Rights Locker API Reference</a>.</p>

  </div>

  <div class="section"><strong class="ph b">Using the Ooyala SDK for Android DTO and DTR capabilities</strong>
      <p class="p">First, you need to set up your app with the Ooyala SDK. If you are not familiar with adding
        an external library like the Ooyala SDK.jar into an Android app, follow the tutorial we
        created on the following page: <a class="xref" href="../tasks/mobile_sdk_android_installation.html#concept_jnv_bk2_yj">../tasks/mobile_sdk_android_installation.html#concept_jnv_bk2_yj</a>.</p>

      <p class="p">We provide the following classes for DTO:</p>

      <div class="p">
        <div class="fig fignone" id="offline_playback_download_to_own_dto_for_android__fig_ozx_kf3_fy">
          <img class="image" id="offline_playback_download_to_own_dto_for_android__image_wr4_lf3_fy" src="../image/mobile_sdk_android_dto_uml.png" height="521" width="619"/>
        </div>

      </div>

      <p class="p">When creating an instance of a <samp class="ph codeph">DashDownloader</samp> to download an asset to
        their Android device, you must implement the <samp class="ph codeph">DashDownloader.Listener</samp> to act
        upon the progress of the download. Supply a <samp class="ph codeph">DashOptions</samp> instance with the
        configuration of the asset that the user wishes to download. The <samp class="ph codeph">folder</samp>
        will be used in the future to playback the downloaded asset.</p>
<p class="p"><strong class="ph b">Runtime
          Permissions</strong></p>
<p class="p"><strong class="ph b">Android 6 (API 23)</strong>, as well as later Android versions, need
        runtime permission to <samp class="ph codeph">WRITE_EXTERNAL_STORAGE</samp>. <a class="xref" href="https://developer.android.com/training/permissions/requesting.html">This page</a>
        gives detailed information on runtime permissions. This <a class="xref" href="https://github.com/ooyala/android-sample-apps/tree/stable/PlaybackLab/DownloadToOwnSampleApp">SampleApp</a> contains sample code illustrating the request of runtime permissions to
        write external storage.</p>
<p class="p"><strong class="ph b">ExoPlayer Classes</strong></p>
<p class="p">The following diagram shows
        what we're using from the ExoPlayer classes. We use them to download a DASH stream, parse
        the MPD and segments and prepare a Widevine session to retrieve the license to playback the
        offline video.</p>

      <div class="p">
        <div class="fig fignone" id="offline_playback_download_to_own_dto_for_android__fig_ibs_ydq_fy">
          <img class="image" id="offline_playback_download_to_own_dto_for_android__image_uzb_f2q_fy" src="../image/mobild_sdk_android_dto_exoplayer.png" height="488" width="857"/>
        </div>

      </div>

      <p class="p">The workflow goes as follows:</p>
<ol class="ol">
        <li class="li"><samp class="ph codeph">OoyalaPlayer</samp> creates <samp class="ph codeph">ExoStreamPlayer</samp> via player
          factory based on the stream type and player configuration.</li>

        <li class="li"><samp class="ph codeph">ExoStreamPlayer</samp> selects renderer builder based on stream type (DASH
          renderer builder for DASH stream, HLS Renderer builder for HLS stream and Extractor
          renderer builder for MP4.</li>

        <li class="li"><samp class="ph codeph">RendererBuilder</samp> fetches stream manifest asynchronously and creates four
          track renderers: video, audio, text (for closed captions) and metadata (for ID3 tags, HLS
          only).</li>

        <li class="li">Customized track selectors are created, either for bitrate control or for offline
          playback (only downloaded tracks are enabled in this scenario).</li>

        <li class="li">If content is protected, DRM session manager needs to be created for license
          acquisition. The initial segment of the video stream is decoded, license acquisition
          request is raised and <samp class="ph codeph">WidevineDrmCallback</samp> method gets called.</li>

        <li class="li">In the meantime, <samp class="ph codeph">ExoStreamPlayer</samp> creates the surface view and binds it
          to the player.</li>

        <li class="li">Now we are ready to playback the video.</li>

      </ol>
<p class="p"><strong class="ph b">Sample App</strong></p>
<p class="p">We provide a sample app that you can use as a guide to build
        your own. It uses the classes we introduced for DTO and shows you a basic implementation to
        download an asset into your app. Here is the link to the sample app: <a class="xref" href="https://github.com/ooyala/android-sample-apps/tree/stable/PlaybackLab/DownloadToOwnSampleApp" target="_blank">https://github.com/ooyala/android-sample-apps/tree/stable/PlaybackLab/DownloadToOwnSampleApp</a>.</p>
<p class="p"><strong class="ph b">Starting
          a Download</strong></p>
<p class="p">To start a download, you must use an instance of
          <samp class="ph codeph">DashDownloader</samp> and call the <samp class="ph codeph">startDownload</samp> method.
          <samp class="ph codeph">DashDownloader</samp> needs a <samp class="ph codeph">DashOptions</samp> object to know which
        asset to download. You supply options like the pcode, embed code, domain, and embed token
        generator. The embedTokenGenerator is required for Widevine assets, as OPT is needed for all
        DRM assets. Look at the sample app for a more real example on how to start a download. The
        following snippet is a basic example of starting a download for a new asset.</p>
<div class="p">
        <pre class="pre codeblock">public void startDownload() {
    File folder = android.os.Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_MOVIES);
    DashOptions options = DashOptions.Builder(PCODE, EMBED_CODE, DOMAIN, folder).setEmbedTokenGenerator(this).build();
    DashDownloader dashDownloader = new DashDownloader(this, options, this);
 	
    downloader.startDownload();
}</pre>

      </div>
<p class="p">The video asset will be saved in the given folder supplied to the
          <samp class="ph codeph">DashOptions</samp> object. We assume the segment URLs are relative to the MPD
        file location; these terms are related to the DASH specification. All the downloaded DASH
        segments will be in the same folder as the MPD. If an MPD file already exists in the folder,
        an error will be thrown. We recommend deleting the contents of this directory when you
        encounter this error.</p>
<p class="p">Note that we supply a <samp class="ph codeph">DashDownloader.Listener</samp>
        to the <samp class="ph codeph">DashDownloader</samp> constructor, as it is needed to get updates for the
        download. This is the only way to supply a listener to <samp class="ph codeph">DashDownloader</samp>. The
        following code shows the method called in <samp class="ph codeph">DashDownloader.Listener</samp>, when a
        download has completed successfully.</p>
<div class="p">
        <pre class="pre codeblock">public void onCompletion() {
    // Download completed, you can ask for the license expiration here if it is a DRM asset
    long expiration = downloader.getLicenseExpirationDate();
}</pre>

      </div>
<p class="p">The download process also downloads a Widevine license if the asset is protected. It is
        used to playback the content offline. The example above shows you how to retrieve the
        license expiration date when the download was completed. You cannot ask for expiration date
        before a download has completed as the files are not there yet.</p>
<p class="p"><strong class="ph b">Selecting the
          Bitrate to Download</strong></p>
<p class="p">When building the <samp class="ph codeph">DashOptions</samp> instance
        supplied to <samp class="ph codeph">DashDownloader</samp>, you can select the minimum bitrate to
        download. The <samp class="ph codeph">setBitrate()</samp> method expects the bitrate value to
          be in bits per second (bps).</p>
<pre class="pre codeblock">DashOptions options = new DashOptions.Builder(PCODE, EMBED, DOMAIN, folder).setEmbedTokenGenerator(this)
.setBitrate(BITRATE_VALUE_INTEGER)
.build();
DashDownloader downloader = new DashDownloader(this, options, this);</pre>
If
      you supply a bitrate to download, when the download process begins, it will search for the
      bitrate closest or equal to the bitrate supplied in your options object,
      whether that bitrate is higher or lower than your supplied bitrate. The following example
      dash manifest master playlist shows three different variants:
      <pre class="pre codeblock">&lt;?xml version="1.0" encoding="utf-8"?&gt;
  &lt;MPD xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="urn:mpeg:dash:schema:mpd:2011" xsi:schemaLocation="urn:mpeg:dash:schema:mpd:2011 http://standards.iso.org/ittf/PubliclyAvailableStandards/MPEG-DASH_schema_files/DASH-MPD.xsd" id="36400" type="static" mediaPresentationDuration="PT51.60S" minBufferTime="PT1S" profiles="urn:mpeg:dash:profile:isoff-main:2011"&gt;
    &lt;Period start="PT0.00S" id="1"&gt;
      &lt;AdaptationSet mimeType="video/mp4" segmentAlignment="true" subsegmentAlignment="true" startWithSAP="1" subsegmentStartsWithSAP="1" bitstreamSwitching="true"&gt;
        &lt;Representation id="1" width="1920" height="1440" frameRate="30/1" bandwidth="4400000" codecs="avc1.42C032"&gt;
        &lt;/Representation&gt;
        &lt;Representation id="2" width="320" height="240" frameRate="30/1" bandwidth="400000" codecs="avc1.42C00D"&gt;
        &lt;/Representation&gt;
        &lt;Representation id="3" width="720" height="540" frameRate="30/1" bandwidth="1200000" codecs="avc1.42C01F"&gt;
        &lt;/Representation&gt;
      &lt;/AdaptationSet&gt;
    &lt;/Period&gt;
  &lt;/MPD&gt;</pre>
For
      example, suppose you wanted to download this example dash asset. If you use <samp class="ph codeph">setBitrate(790000)</samp>, then it will select
      the variant with a <samp class="ph codeph">BANDWIDTH</samp> of <samp class="ph codeph">400000</samp>. 
      That is the variant that will be downloaded because 790000 is closer to 400000 than it is to 1200000.
      If you use <samp class="ph codeph">setBitrate(810000)</samp>, then it will
      select the variant with the <samp class="ph codeph">BANDWIDTH</samp> of <samp class="ph codeph">1200000</samp>.
          <p class="p"><strong class="ph b">Checking the Download Progress</strong></p>
<p class="p"><samp class="ph codeph">DashDownloader.Listener</samp>
        lets you know about the progress of a download through its <samp class="ph codeph">onPercentage</samp>
        method.</p>
<div class="p">
        <pre class="pre codeblock">public void onPercentage(int percentCompleted) {
    // percentCompleted is an integer between 0 and 100
}</pre>

      </div>
<p class="p"><strong class="ph b">Canceling a Download in Progress</strong></p>
<p class="p">During a download, you can cancel it by
        calling the <samp class="ph codeph">abort</samp> method of the <samp class="ph codeph">DashDownloader</samp> object.</p>
<div class="p">
        <pre class="pre codeblock">public void abort() {
    downloader.abort();
}</pre>

      </div>
<p class="p">Calling <samp class="ph codeph">abort</samp> will trigger <samp class="ph codeph">DashDownloader.Listener</samp> to
        call its <samp class="ph codeph">onAbort</samp> method.</p>
<div class="p">
        <pre class="pre codeblock">public void onAbort() {
    // Download canceled
}</pre>

      </div>
<p class="p"><strong class="ph b">Playing an Offline Video</strong></p>
<p class="p">Now that you have an offline video stored in your
        device, you can play it back using the <samp class="ph codeph">OoyalaPlayer</samp>. The following code
        assumes you already setup an <samp class="ph codeph">OoyalaPlayer</samp> instance in an Android
        Activity.</p>
<div class="p">
        <pre class="pre codeblock">public void initializePlayer() {
    PlayerDomain domain = new PlayerDomain(DOMAIN);
    Options options = new Options.Builder().setShowPromoImage(false).setShowNativeLearnMoreButton(false).setUseExoPlayer(true).build();
    OoyalaPlayer player = new OoyalaPlayer(PCODE, domain, options);

    /*
     * add more configuration here, for example, the Skin Player setup
     */ 

    // Use the folder where we downloaded the asset
    File folder = new File(android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_MOVIES), EMBED_CODE);
    OfflineVideo offlineVideo = OfflineVideo.getVideo(folder); // Gets the video we already downloaded

    // Initialize the player with the downloaded video
    player.setUnbundledVideo(offlineVideo);
}</pre>

      </div>
<p class="p">After calling <samp class="ph codeph">setUnbundledVideo</samp> you should be able to playback the
        offline asset successfully using the <samp class="ph codeph">OoyalaPlayer</samp>. Remember to use the same
        folder you used when downloading the asset.</p>
<p class="p"><strong class="ph b">Deleting a downloaded
        asset</strong></p>
<p class="p">Here's a code snippet showing how to delete both the contents and license of
        an asset.</p>
<div class="p">
        <pre class="pre codeblock">public void deleteAsset() {
    // Assumes the downloader instance (DashDownloader) was setup with the correct folder.
    downloader.deleteAll();
}</pre>

      </div>
<p class="p">This will delete the contents that were stored in the folder supplied to the
          <samp class="ph codeph">DashOptions</samp> object when initializing a <samp class="ph codeph">DashDownloader</samp>
        instance.</p>
</div>

    
    

   
   
   
   
   
   <div class="section"><h2 class="title sectiontitle">Reference</h2>
     <ul class="ul">
       <li class="li"><a class="xref" href="https://google.github.io/ExoPlayer/guide.html" target="_blank">ExoPlayer Development Guide</a></li>

     </ul>
</div>

 </div>

<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="mobile_sdk_android_about.html">Working with the Android SDK</a></div>
</div>
</div>

</body>
</html>